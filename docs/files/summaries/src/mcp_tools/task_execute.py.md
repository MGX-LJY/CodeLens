# æ–‡ä»¶åˆ†ææŠ¥å‘Šï¼šsrc/mcp_tools/task_execute.py

## æ–‡ä»¶æ¦‚è¿°

**CodeLensæ™ºèƒ½ä»»åŠ¡æ‰§è¡Œå¼•æ“**â€”â€”CodeLensç³»ç»Ÿçš„æ ¸å¿ƒæ‰§è¡Œç»„ä»¶ï¼Œå®ç°äº†å®Œæ•´çš„3é˜¶æ®µæ–‡æ¡£ç”Ÿæˆå·¥ä½œæµç¨‹çš„ä»»åŠ¡æ‰§è¡Œç®¡ç†ã€‚è¯¥æ–‡ä»¶æä¾›äº†é«˜åº¦æ™ºèƒ½åŒ–çš„ä»»åŠ¡æ‰§è¡ŒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¸‰ç§æ‰§è¡Œæ¨¡å¼ã€ç©ºæ–‡ä»¶æ£€æµ‹ä¸è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆã€**ğŸ”¥æ–°å¢å¤§æ–‡ä»¶åˆ†ç‰‡å¤„ç†ä¸åˆå¹¶**ã€è¾“å‡ºéªŒè¯ã€ä¸Šä¸‹æ–‡å¢å¼ºç­‰é«˜çº§ç‰¹æ€§ã€‚ä½œä¸ºMCPåè®®çš„task_executeå·¥å…·å®ç°ï¼Œå®ƒé›†æˆäº†TaskManagerã€PhaseControllerã€StateTrackerç­‰æ ¸å¿ƒç»„ä»¶ï¼Œå¹¶æ–°å¢äº†å¤§æ–‡ä»¶æ™ºèƒ½å¤„ç†èƒ½åŠ›ï¼Œå®ç°äº†å®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚åŸºäºFileServiceé›†æˆçš„é¡¹ç›®åˆ†æï¼Œç›´æ¥æ‰§è¡Œæ–‡ä»¶å±‚â†’æ¶æ„å±‚â†’é¡¹ç›®å±‚çš„æ–‡æ¡£ç”Ÿæˆæµç¨‹ã€‚

## åŸºæœ¬ä¿¡æ¯

- **æ–‡ä»¶è·¯å¾„**: `src/mcp_tools/task_execute.py`
- **æ–‡ä»¶ç±»å‹**: .py
- **ä»£ç è¡Œæ•°**: ~1700è¡Œ (ğŸ”¥å¤§å¹…æ‰©å±•)
- **ä¸»è¦ç±»**: 2ä¸ª (`TaskExecutor`, `TaskExecuteTool`)
- **ä¸»è¦å‡½æ•°**: 25+ä¸ªæ ¸å¿ƒæ–¹æ³• (ğŸ”¥æ–°å¢10+ä¸ªå¤§æ–‡ä»¶å¤„ç†æ–¹æ³•)
- **é›†æˆç»„ä»¶**: TaskManager, PhaseController, StateTracker, FileService, TemplateService + **ğŸ”¥LargeFileHandleré›†æˆ**

## ä»£ç ç»“æ„åˆ†æ

### å¯¼å…¥ä¾èµ–
```python
# ç³»ç»ŸåŸºç¡€æ¨¡å—
import sys, os, json, time
from pathlib import Path
from typing import Dict, Any, List, Optional

# CodeLensæ ¸å¿ƒç»„ä»¶
from src.task_engine.task_manager import TaskManager, TaskStatus, Task
from src.task_engine.phase_controller import PhaseController, Phase
from src.task_engine.state_tracker import StateTracker
from src.services.file_service import FileService
from src.templates.document_templates import TemplateService
from src.logging import get_logger

# ğŸ”¥æ–°å¢: å¤§æ–‡ä»¶å¤„ç†ç›¸å…³ç±»
from src.services.large_file_handler import ChunkingResult, CodeChunk
HAS_LARGE_FILE_HANDLER = True  # å¤§æ–‡ä»¶å¤„ç†å™¨å¯ç”¨æ€§æ ‡å¿—
```

### å…¨å±€å˜é‡å’Œå¸¸é‡
- **project_root**: åŠ¨æ€è®¡ç®—çš„é¡¹ç›®æ ¹ç›®å½•è·¯å¾„
- **MCPå·¥å…·æ ‡è¯†**: `tool_name="task_execute"`, `description="æ‰§è¡Œå•ä¸ªæˆ–æ‰¹é‡ä»»åŠ¡ï¼Œæä¾›æ¨¡æ¿å’Œä¸Šä¸‹æ–‡ä¿¡æ¯"`
- **ğŸ”¥æ–°å¢**: **HAS_LARGE_FILE_HANDLER**: å¤§æ–‡ä»¶å¤„ç†å™¨å¯ç”¨æ€§æ£€æŸ¥

### é…ç½®å’Œè®¾ç½®
- **æ‰§è¡Œæ¨¡å¼**: `["prepare", "execute", "complete"]` - ä¸‰é˜¶æ®µæ‰§è¡Œæ¨¡å¼
- **MCPæ¥å£é…ç½®**: å®Œæ•´çš„inputSchemaå®šä¹‰ï¼Œæ”¯æŒ6ä¸ªä¸»è¦å‚æ•°
- **æ—¥å¿—é…ç½®**: ç»„ä»¶çº§æ—¥å¿—è®°å½•ï¼Œæ”¯æŒæ“ä½œè¿½è¸ª
- **éªŒè¯è§„åˆ™**: è¾“å‡ºæ–‡ä»¶æœ€å°100å­—èŠ‚éªŒè¯ï¼Œç©ºæ–‡ä»¶â‰¤10å­—ç¬¦æ£€æµ‹
- **ğŸ”¥æ–°å¢**: **å¤§æ–‡ä»¶å¤„ç†é…ç½®**: 50KBåˆ†ç‰‡é˜ˆå€¼ï¼Œ120KBå¤„ç†ä¸Šé™ï¼Œè‡ªåŠ¨åˆ†ç‰‡å¯ç”¨

## å‡½æ•°è¯¦ç»†åˆ†æ

### å‡½æ•°æ¦‚è§ˆè¡¨ ğŸ”¥é‡å¤§æ‰©å±•
| å‡½æ•°å | å‚æ•° | è¿”å›å€¼ | æ ¸å¿ƒåŠŸèƒ½ |
|--------|------|--------|----------|
| `TaskExecutor.__init__` | project_path | None | ğŸ”¥æ›´æ–°ï¼šåˆå§‹åŒ–æ‰§è¡Œå™¨ï¼Œé›†æˆå¤§æ–‡ä»¶å¤„ç†èƒ½åŠ› |
| `prepare_task_execution` | task_id, context_enhancement | Dict | å‡†å¤‡æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ£€æŸ¥ä¾èµ–å’Œæ¨¡æ¿ |
| `execute_task` | task_id, mark_in_progress | Dict | ğŸ”¥æ›´æ–°ï¼šä¸»æ‰§è¡Œæ–¹æ³•ï¼Œæ”¯æŒå¤§æ–‡ä»¶è‡ªåŠ¨å¤„ç† |
| `_execute_scan_task` | task_id | Dict | è‡ªåŠ¨æ‰§è¡Œscanä»»åŠ¡çš„ç‰¹æ®Šå¤„ç† |
| `_generate_scan_report` | scan_data | str | ç”Ÿæˆç»“æ„åŒ–é¡¹ç›®æ‰«ææŠ¥å‘Š |
| `_check_and_handle_empty_file` | task_id | Optional[Dict] | æ£€æµ‹å¹¶è‡ªåŠ¨å¤„ç†ç©ºæ–‡ä»¶ |
| `ğŸ”¥æ–°å¢ _check_and_handle_large_file` | task_id | Optional[Dict] | **æ ¸å¿ƒæ–°åŠŸèƒ½**ï¼šæ£€æµ‹å¹¶è‡ªåŠ¨å¤„ç†å¤§æ–‡ä»¶ |
| `ğŸ”¥æ–°å¢ _process_chunks_and_merge` | task, chunking_result | str | å¤„ç†ä»£ç åˆ†ç‰‡å¹¶åˆå¹¶ç”Ÿæˆæœ€ç»ˆæ–‡æ¡£ |
| `ğŸ”¥æ–°å¢ _sort_chunks_by_dependencies` | chunks | List[CodeChunk] | æ ¹æ®ä¾èµ–å…³ç³»å¯¹åˆ†ç‰‡æ’åº |
| `ğŸ”¥æ–°å¢ _generate_chunk_documentation` | chunk, template, task | str | ä¸ºå•ä¸ªä»£ç åˆ†ç‰‡ç”Ÿæˆæ–‡æ¡£ |
| `ğŸ”¥æ–°å¢ _generate_class_chunk_doc` | chunk, template | str | ç”Ÿæˆç±»åˆ†ç‰‡çš„ä¸“ä¸šæ–‡æ¡£ |
| `ğŸ”¥æ–°å¢ _generate_function_chunk_doc` | chunk, template | str | ç”Ÿæˆå‡½æ•°åˆ†ç‰‡çš„ä¸“ä¸šæ–‡æ¡£ |
| `ğŸ”¥æ–°å¢ _generate_module_chunk_doc` | chunk, template | str | ç”Ÿæˆæ¨¡å—çº§åˆ†ç‰‡çš„ä¸“ä¸šæ–‡æ¡£ |
| `ğŸ”¥æ–°å¢ _generate_generic_chunk_doc` | chunk, template | str | ç”Ÿæˆé€šç”¨åˆ†ç‰‡çš„ä¸“ä¸šæ–‡æ¡£ |
| `ğŸ”¥æ–°å¢ _merge_chunk_documentations` | chunk_docs, task, result | str | åˆå¹¶æ‰€æœ‰åˆ†ç‰‡æ–‡æ¡£ä¸ºæœ€ç»ˆæ–‡æ¡£ |
| `ğŸ”¥æ–°å¢ get_chunking_stats` | - | Dict[str, Any] | è·å–åˆ†ç‰‡å¤„ç†ç»Ÿè®¡ä¿¡æ¯ |
| `_generate_empty_file_doc` | file_path, content | str | ä¸ºç©ºæ–‡ä»¶ç”Ÿæˆæ ‡å‡†åŒ–æ–‡æ¡£ |
| `complete_task` | task_id, success, error_message | Dict | å®Œæˆä»»åŠ¡ï¼ŒåŒ…å«è¾“å‡ºéªŒè¯ |
| `_check_dependencies` | task | Dict | æ£€æŸ¥ä»»åŠ¡ä¾èµ–æ»¡è¶³æƒ…å†µ |
| `_get_template_info` | task | Dict | è·å–ä»»åŠ¡æ¨¡æ¿ä¿¡æ¯å’Œå…ƒæ•°æ® |
| `_build_execution_context` | task, context_enhancement | Dict | æ„å»ºå®Œæ•´æ‰§è¡Œä¸Šä¸‹æ–‡ |
| `_get_file_context` | target_file, enhanced | Dict | è·å–æ–‡ä»¶çº§ä¸Šä¸‹æ–‡ä¿¡æ¯ |
| `_get_project_context` | - | Dict | è·å–é¡¹ç›®çº§ä¸Šä¸‹æ–‡ä¿¡æ¯ |
| `_get_phase_context` | phase | Dict | è·å–é˜¶æ®µçº§ä¸Šä¸‹æ–‡ä¿¡æ¯ |
| `_get_generation_guidance` | task | Dict | è·å–ä»»åŠ¡ç±»å‹ç‰¹å®šçš„ç”ŸæˆæŒ‡å¯¼ |
| `_find_related_files` | target_file | List[str] | æŸ¥æ‰¾ç›¸å…³æ–‡ä»¶ï¼ˆæœ€å¤š5ä¸ªï¼‰ |

### æ ¸å¿ƒæ–¹æ³•è¯¦ç»†è¯´æ˜

**`TaskExecutor.__init__(self, project_path: str)` ğŸ”¥é‡å¤§æ›´æ–°** *ç¬¬27-42è¡Œ*
- åˆå§‹åŒ–é¡¹ç›®è·¯å¾„å’Œæ—¥å¿—è®°å½•å™¨
- åˆ›å»ºTaskManagerã€PhaseControllerã€StateTrackeræ ¸å¿ƒå®ä¾‹
- **ğŸ”¥æ–°å¢**: é›†æˆå¤§æ–‡ä»¶å¤„ç†èƒ½åŠ›çš„FileServiceå®ä¾‹
- **ğŸ”¥æ–°å¢**: å¤§æ–‡ä»¶å¤„ç†é…ç½®å’Œé˜ˆå€¼è®¾ç½®
- **ğŸ”¥æ–°å¢**: å¤§æ–‡ä»¶å¤„ç†èƒ½åŠ›æ£€æŸ¥å’Œæ—¥å¿—è®°å½•

**`execute_task(self, task_id: str, mark_in_progress: bool = True)` ğŸ”¥é‡å¤§æ›´æ–°** *ç¬¬107-170è¡Œ*
- **çŠ¶æ€éªŒè¯**: æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å¤„äºå¯æ‰§è¡ŒçŠ¶æ€ï¼ˆPENDING/FAILEDï¼‰
- **ğŸ”¥æ–°å¢**: **åŒé‡æ–‡ä»¶é¢„å¤„ç†**:
  - **ç©ºæ–‡ä»¶æ£€æŸ¥**: è°ƒç”¨`_check_and_handle_empty_file`è‡ªåŠ¨å¤„ç†
  - **ğŸ”¥å¤§æ–‡ä»¶æ£€æŸ¥**: è°ƒç”¨`_check_and_handle_large_file`è‡ªåŠ¨å¤„ç†
- **ç‰¹æ®Šå¤„ç†**: 
  - scanä»»åŠ¡ï¼šè°ƒç”¨`_execute_scan_task`è‡ªåŠ¨æ‰§è¡Œ
- **çŠ¶æ€æ›´æ–°**: æ ‡è®°ä»»åŠ¡ä¸ºIN_PROGRESSï¼Œè®°å½•å¼€å§‹äº‹ä»¶
- **æ‰§è¡Œä¸Šä¸‹æ–‡**: è°ƒç”¨`prepare_task_execution`è·å–å®Œæ•´ä¸Šä¸‹æ–‡

**ğŸ”¥æ–°å¢ `_check_and_handle_large_file(self, task_id: str) -> Optional[Dict[str, Any]]`** *ç¬¬856-927è¡Œ*
- **æ ¸å¿ƒæ–°åŠŸèƒ½**: æ£€æµ‹50KB-120KBèŒƒå›´çš„å¤§æ–‡ä»¶å¹¶è‡ªåŠ¨åˆ†ç‰‡å¤„ç†
- **æ™ºèƒ½æ£€æµ‹**: ä½¿ç”¨FileServiceæ£€æŸ¥æ–‡ä»¶æ˜¯å¦éœ€è¦åˆ†ç‰‡å¤„ç†
- **è‡ªåŠ¨å¤„ç†**: è°ƒç”¨å¤§æ–‡ä»¶å¤„ç†å™¨æ‰§è¡Œè¯­ä¹‰åˆ†ç‰‡
- **æ–‡æ¡£ç”Ÿæˆ**: è°ƒç”¨`_process_chunks_and_merge`ç”Ÿæˆåˆå¹¶æ–‡æ¡£
- **è‡ªåŠ¨å®Œæˆ**: ç›´æ¥å®Œæˆä»»åŠ¡å¹¶è¿”å›å¤„ç†ç»“æœ
- **é”™è¯¯æ¢å¤**: åˆ†ç‰‡å¤±è´¥æ—¶æ¢å¤ä»»åŠ¡çŠ¶æ€ï¼Œä¸ä¸­æ–­æ­£å¸¸æµç¨‹

**ğŸ”¥æ–°å¢ `_process_chunks_and_merge(self, task: Task, chunking_result: ChunkingResult) -> str`** *ç¬¬929-955è¡Œ*
- **åˆ†ç‰‡å¤„ç†åè°ƒ**: åè°ƒæ•´ä¸ªåˆ†ç‰‡æ–‡æ¡£ç”Ÿæˆæµç¨‹
- **æ¨¡æ¿é›†æˆ**: è·å–ä»»åŠ¡æ¨¡æ¿å¹¶ä¼ é€’ç»™åˆ†ç‰‡å¤„ç†
- **ä¾èµ–æ’åº**: è°ƒç”¨`_sort_chunks_by_dependencies`å¯¹åˆ†ç‰‡æ’åº
- **æ‰¹é‡ç”Ÿæˆ**: ä¸ºæ¯ä¸ªåˆ†ç‰‡ç”Ÿæˆä¸“ä¸šæ–‡æ¡£
- **æ™ºèƒ½åˆå¹¶**: è°ƒç”¨`_merge_chunk_documentations`ç”Ÿæˆæœ€ç»ˆæ–‡æ¡£

**ğŸ”¥æ–°å¢ `_generate_chunk_documentation(self, chunk: CodeChunk, template: str, task: Task) -> str`** *ç¬¬972-982è¡Œ*
- **ç±»å‹è·¯ç”±**: æ ¹æ®åˆ†ç‰‡ç±»å‹è·¯ç”±åˆ°ä¸“ä¸šçš„æ–‡æ¡£ç”Ÿæˆå™¨
- **æ¨¡æ¿ä¼ é€’**: å°†æ¨¡æ¿ä¿¡æ¯ä¼ é€’ç»™å…·ä½“çš„ç”Ÿæˆå™¨
- **ä¸Šä¸‹æ–‡ä¿æŒ**: ä¿æŒä»»åŠ¡ä¸Šä¸‹æ–‡ä¿¡æ¯
- **ä¸“ä¸šåŒ–**: æ¯ç§åˆ†ç‰‡ç±»å‹æœ‰ä¸“é—¨çš„æ–‡æ¡£ç”Ÿæˆé€»è¾‘

**ğŸ”¥æ–°å¢ `_generate_class_chunk_doc(self, chunk: CodeChunk, template: str) -> str`** *ç¬¬984-1013è¡Œ*
- **ç±»åˆ†ç‰‡ä¸“ä¸šæ–‡æ¡£**: ç”Ÿæˆç±»çš„è¯¦ç»†åˆ†ææ–‡æ¡£
- **å…ƒæ•°æ®åˆ©ç”¨**: åˆ©ç”¨ç±»åã€æ–¹æ³•æ•°é‡ã€åŸºç±»ç­‰å…ƒæ•°æ®
- **ä»£ç å±•ç¤º**: åŒ…å«å®Œæ•´çš„ç±»ä»£ç å’Œè¯­æ³•é«˜äº®
- **ä¾èµ–åˆ†æ**: å±•ç¤ºç±»çš„å®šä¹‰ç¬¦å·å’Œå¼•ç”¨å…³ç³»
- **ç‰¹å¾è¯†åˆ«**: è¯†åˆ«ç§æœ‰ç±»ã€ç»§æ‰¿å…³ç³»ç­‰ç‰¹å¾

**ğŸ”¥æ–°å¢ `_generate_function_chunk_doc(self, chunk: CodeChunk, template: str) -> str`** *ç¬¬1015-1046è¡Œ*
- **å‡½æ•°/æ–¹æ³•ä¸“ä¸šæ–‡æ¡£**: åŒºåˆ†ç±»æ–¹æ³•å’Œæ¨¡å—å‡½æ•°
- **å‚æ•°åˆ†æ**: å±•ç¤ºå‚æ•°æ•°é‡å’Œå‡½æ•°ç‰¹å¾
- **æ–¹æ³•ç‰¹å¾**: è¯†åˆ«ç§æœ‰æ–¹æ³•ã€ç‰¹æ®Šæ–¹æ³•ï¼ˆ__init__ç­‰ï¼‰
- **æ‰€å±å…³ç³»**: æ˜¾ç¤ºæ–¹æ³•æ‰€å±çš„ç±»ä¿¡æ¯
- **å®ç°åˆ†æ**: åŒ…å«å®Œæ•´çš„å®ç°ä»£ç å’Œä¾èµ–å…³ç³»

**ğŸ”¥æ–°å¢ `_merge_chunk_documentations(self, chunk_docs: List[Dict], task: Task, chunking_result: ChunkingResult) -> str`** *ç¬¬1089-1152è¡Œ*
- **æ–‡æ¡£åˆå¹¶æ ¸å¿ƒ**: å°†æ‰€æœ‰åˆ†ç‰‡æ–‡æ¡£åˆå¹¶ä¸ºå®Œæ•´çš„åˆ†ææŠ¥å‘Š
- **ä¸“ä¸šå¤´éƒ¨**: ç”ŸæˆåŒ…å«æ–‡ä»¶ä¿¡æ¯ã€åˆ†ç‰‡ç»Ÿè®¡çš„ä¸“ä¸šå¤´éƒ¨
- **åˆ†ç‰‡æ¦‚è§ˆ**: æä¾›åˆ†ç‰‡ç±»å‹ç»Ÿè®¡å’Œå¤„ç†æ¦‚è§ˆ
- **è¯¦ç»†åˆ†æ**: æœ‰åºåˆå¹¶æ‰€æœ‰åˆ†ç‰‡çš„è¯¦ç»†æ–‡æ¡£
- **å¤„ç†æ€»ç»“**: åŒ…å«å¤„ç†ç»Ÿè®¡ã€æˆåŠŸç‡ã€æ€§èƒ½ä¿¡æ¯çš„å°¾éƒ¨

## ğŸ”¥å¤§æ–‡ä»¶å¤„ç†å·¥ä½œæµç¨‹

### åŒé˜ˆå€¼å¤„ç†ç­–ç•¥ (v1.1.1.0)
- **åˆ†ç‰‡é˜ˆå€¼**: 50KB - å¯åŠ¨åˆ†ç‰‡å¤„ç†çš„é˜ˆå€¼
- **å¤„ç†ä¸Šé™**: 120KB - æ–‡ä»¶å¤„ç†çš„æœ€å¤§é™åˆ¶
- **å¤„ç†èŒƒå›´**: 50KB-120KBä¹‹é—´æ–‡ä»¶é€šè¿‡æ™ºèƒ½åˆ†ç‰‡å¤„ç†
- **è·³è¿‡ç­–ç•¥**: è¶…è¿‡120KBçš„æ–‡ä»¶è¢«å®Œå…¨è·³è¿‡
- **å…¼å®¹æ€§**: ç°æœ‰50KBåˆ†ç‰‡é€»è¾‘ä¿æŒä¸å˜

### å¤§æ–‡ä»¶è‡ªåŠ¨æ£€æµ‹ä¸å¤„ç†æµç¨‹
```mermaid
graph TD
    A[execute_taskè°ƒç”¨] --> B[æ–‡ä»¶é¢„å¤„ç†é˜¶æ®µ]
    B --> C[ç©ºæ–‡ä»¶æ£€æŸ¥]
    C --> D{æ˜¯ç©ºæ–‡ä»¶?}
    D -->|æ˜¯| E[ç”Ÿæˆç©ºæ–‡ä»¶æ–‡æ¡£]
    D -->|å¦| F[ğŸ”¥å¤§æ–‡ä»¶æ£€æŸ¥]
    
    F --> G{æ–‡ä»¶>50KBåˆ†ç‰‡é˜ˆå€¼?}
    G -->|å¦| H[æ­£å¸¸ä»»åŠ¡æ‰§è¡Œæµç¨‹]
    G -->|æ˜¯| I[ğŸ”¥è°ƒç”¨å¤§æ–‡ä»¶å¤„ç†å™¨\n50KB-120KBèŒƒå›´]
    
    I --> J[è¯­è¨€æ£€æµ‹]
    J --> K[ASTè¯­ä¹‰åˆ†ç‰‡]
    K --> L[ä¾èµ–å…³ç³»åˆ†æ]
    L --> M[åˆ†ç‰‡æ’åº]
    M --> N[æ‰¹é‡æ–‡æ¡£ç”Ÿæˆ]
    N --> O[æ™ºèƒ½æ–‡æ¡£åˆå¹¶]
    O --> P[è‡ªåŠ¨å®Œæˆä»»åŠ¡]
    
    E --> Q[è¿”å›å¤„ç†ç»“æœ]
    P --> Q
    H --> R[å¸¸è§„æ‰§è¡Œæµç¨‹]
    
    style I fill:#f3e5f5
    style O fill:#e8f5e8
    style P fill:#fff3e0
```

### åˆ†ç‰‡æ–‡æ¡£ç”Ÿæˆæ¶æ„
```mermaid
graph TD
    A[ChunkingResultè¾“å…¥] --> B[åˆ†ç‰‡ç±»å‹è¯†åˆ«]
    B --> C{åˆ†ç‰‡ç±»å‹?}
    
    C -->|class| D[_generate_class_chunk_doc]
    C -->|function| E[_generate_function_chunk_doc]
    C -->|module| F[_generate_module_chunk_doc]
    C -->|å…¶ä»–| G[_generate_generic_chunk_doc]
    
    D --> H[ç±»ç‰¹å¾åˆ†æ]
    E --> I[å‡½æ•°ç‰¹å¾åˆ†æ]
    F --> J[æ¨¡å—çº§åˆ†æ]
    G --> K[é€šç”¨ä»£ç åˆ†æ]
    
    H --> L[ç”Ÿæˆç±»æ–‡æ¡£ç‰‡æ®µ]
    I --> M[ç”Ÿæˆå‡½æ•°æ–‡æ¡£ç‰‡æ®µ]
    J --> N[ç”Ÿæˆæ¨¡å—æ–‡æ¡£ç‰‡æ®µ]
    K --> O[ç”Ÿæˆé€šç”¨æ–‡æ¡£ç‰‡æ®µ]
    
    L --> P[æ–‡æ¡£ç‰‡æ®µæ”¶é›†]
    M --> P
    N --> P
    O --> P
    
    P --> Q[_merge_chunk_documentations]
    Q --> R[ç”Ÿæˆå®Œæ•´æ–‡æ¡£]
    
    style D fill:#e3f2fd
    style E fill:#f1f8e9
    style F fill:#fff8e1
    style G fill:#fce4ec
```

## ç±»è¯¦ç»†åˆ†æ

### ç±»æ¦‚è§ˆè¡¨
| ç±»å | ç»§æ‰¿å…³ç³» | ä¸»è¦èŒè´£ | å®ä¾‹æ–¹æ³•æ•°é‡ |
|------|----------|----------|-------------|
| `TaskExecutor` | æ— ç»§æ‰¿ | ä»»åŠ¡æ‰§è¡Œå¼•æ“ + ğŸ”¥å¤§æ–‡ä»¶å¤„ç†é›†æˆ | 25+ä¸ª (ğŸ”¥æ–°å¢10+ä¸ª) |
| `TaskExecuteTool` | æ— ç»§æ‰¿ | MCPå·¥å…·æ¥å£ | 3ä¸ª |

### ç±»è¯¦ç»†è¯´æ˜

**`TaskExecutor` ğŸ”¥é‡å¤§å‡çº§**
- **æ ¸å¿ƒèŒè´£æ‰©å±•**: ä»ä»»åŠ¡æ‰§è¡Œå™¨å‡çº§ä¸ºæ™ºèƒ½æ–‡ä»¶å¤„ç†æ‰§è¡Œå™¨
- **æ–°å¢èƒ½åŠ›**:
  - å¤§æ–‡ä»¶è‡ªåŠ¨æ£€æµ‹å’Œåˆ†ç‰‡å¤„ç†
  - å¤šç±»å‹ä»£ç åˆ†ç‰‡çš„ä¸“ä¸šæ–‡æ¡£ç”Ÿæˆ
  - æ™ºèƒ½æ–‡æ¡£åˆå¹¶å’Œè´¨é‡ä¿è¯
  - åˆ†ç‰‡å¤„ç†ç»Ÿè®¡å’Œç›‘æ§
- **å¤„ç†æµç¨‹**: ç©ºæ–‡ä»¶ â†’ å¤§æ–‡ä»¶ â†’ å¸¸è§„ä»»åŠ¡çš„ä¸‰å±‚å¤„ç†æ¶æ„
- **è‡ªåŠ¨åŒ–ç¨‹åº¦**: å¤§æ–‡ä»¶å¤„ç†å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
- **å‘åå…¼å®¹**: å®Œå…¨å…¼å®¹åŸæœ‰åŠŸèƒ½ï¼Œæ–°åŠŸèƒ½é€æ˜é›†æˆ

**`TaskExecuteTool`**
- **MCPæ¥å£**: æä¾›æ ‡å‡†çš„MCPå·¥å…·æ¥å£
- **å‚æ•°éªŒè¯**: å®Œæ•´çš„å‚æ•°éªŒè¯å’Œç±»å‹æ£€æŸ¥
- **æ‰§è¡Œå§”æ‰˜**: å§”æ‰˜ç»™TaskExecutorå®é™…æ‰§è¡Œ
- **ç»“æœæ ¼å¼åŒ–**: æ ¼å¼åŒ–è¿”å›ç»“æœç¬¦åˆMCPæ ‡å‡†

## ğŸ”¥åˆ†ç‰‡æ–‡æ¡£ç”Ÿæˆç‰¹æ€§

### ç±»åˆ†ç‰‡æ–‡æ¡£æ¨¡æ¿
```markdown
### ç±»: ClassName

**å®šä¹‰ä½ç½®**: ç¬¬ X-Y è¡Œ
**å¤æ‚åº¦è¯„åˆ†**: N.N
**å¤§å°**: XXX å­—èŠ‚

#### ç±»ç‰¹å¾
- æ–¹æ³•æ•°é‡: N
- ç»§æ‰¿å…³ç³»: BaseClass1, BaseClass2
- æ˜¯å¦ä¸ºç§æœ‰ç±»: æ˜¯/å¦

#### ç±»ç»“æ„åˆ†æ
[å®Œæ•´ä»£ç å±•ç¤º]

#### ä¾èµ–å…³ç³»
- **å®šä¹‰çš„ç¬¦å·**: symbol1, symbol2
- **å¼•ç”¨çš„ç¬¦å·**: ref1, ref2
```

### å‡½æ•°åˆ†ç‰‡æ–‡æ¡£æ¨¡æ¿
```markdown
### æ–¹æ³•/å‡½æ•°: function_name

**å®šä¹‰ä½ç½®**: ç¬¬ X-Y è¡Œ
**å¤æ‚åº¦è¯„åˆ†**: N.N
**å‚æ•°æ•°é‡**: N
**æ‰€å±ç±»**: ClassName (å¦‚æœæ˜¯æ–¹æ³•)

#### å‡½æ•°ç‰¹å¾
- ç±»å‹: ç±»æ–¹æ³•/æ¨¡å—å‡½æ•°
- ç§æœ‰æ–¹æ³•: æ˜¯/å¦
- ç‰¹æ®Šæ–¹æ³•: æ˜¯/å¦

#### å®ç°åˆ†æ
[å®Œæ•´ä»£ç å±•ç¤º]

#### ä¾èµ–åˆ†æ
[ä¾èµ–å…³ç³»åˆ†æ]
```

### åˆå¹¶æ–‡æ¡£ç»“æ„
```markdown
# æ–‡ä»¶åˆ†ææŠ¥å‘Šï¼šfilename

## æ–‡ä»¶æ¦‚è¿°
**å¤§æ–‡ä»¶åˆ†ç‰‡å¤„ç†æŠ¥å‘Š** - è‡ªåŠ¨åˆ†ç‰‡å¤„ç†è¯´æ˜

## åŸºæœ¬ä¿¡æ¯
- **æ–‡ä»¶è·¯å¾„**: `path`
- **æ–‡ä»¶å¤§å°**: XXX KB (åˆ†ç‰‡é˜ˆå€¼50KB, å¤„ç†ä¸Šé™120KB)
- **åˆ†ç‰‡æ•°é‡**: Nä¸ª
- **å¤„ç†æ–¹æ³•**: python_ast_semantic
- **å¤„ç†æ—¶é—´**: X.XX ç§’

## åˆ†ç‰‡å¤„ç†ç»“æœ
### åˆ†ç‰‡æ¦‚è§ˆ
- Class åˆ†ç‰‡: N ä¸ª
- Function åˆ†ç‰‡: N ä¸ª

## è¯¦ç»†åˆ†æ
[æ‰€æœ‰åˆ†ç‰‡æ–‡æ¡£çš„æœ‰åºåˆå¹¶]

## åˆ†ç‰‡å¤„ç†æ€»ç»“
[å¤„ç†ç»Ÿè®¡å’ŒæŠ€æœ¯è¯´æ˜]
```

## å‡½æ•°è°ƒç”¨æµç¨‹å›¾ ğŸ”¥æ›´æ–°
```mermaid
graph TD
    A[TaskExecutor.execute_task] --> B[ä»»åŠ¡çŠ¶æ€æ£€æŸ¥]
    B --> C[scanä»»åŠ¡ç‰¹æ®Šå¤„ç†]
    C --> D[æ–‡ä»¶é¢„å¤„ç†é˜¶æ®µ]
    
    D --> E[_check_and_handle_empty_file]
    E --> F{æ˜¯ç©ºæ–‡ä»¶?}
    F -->|æ˜¯| G[ç”Ÿæˆç©ºæ–‡ä»¶æ–‡æ¡£å¹¶å®Œæˆ]
    F -->|å¦| H[ğŸ”¥_check_and_handle_large_file]
    
    H --> I{æ˜¯å¤§æ–‡ä»¶?}
    I -->|å¦| J[æ ‡è®°ä»»åŠ¡è¿›è¡Œä¸­]
    I -->|æ˜¯| K[ğŸ”¥å¤§æ–‡ä»¶åˆ†ç‰‡å¤„ç†]
    
    K --> L[FileService.read_file_with_chunking]
    L --> M[LargeFileHandler.process_large_file]
    M --> N[ğŸ”¥_process_chunks_and_merge]
    
    N --> O[ğŸ”¥_sort_chunks_by_dependencies]
    O --> P[ğŸ”¥æ‰¹é‡_generate_chunk_documentation]
    P --> Q[ğŸ”¥_merge_chunk_documentations]
    Q --> R[å†™å…¥æœ€ç»ˆæ–‡æ¡£]
    R --> S[è‡ªåŠ¨å®Œæˆä»»åŠ¡]
    
    J --> T[prepare_task_execution]
    T --> U[è¿”å›æ‰§è¡Œä¸Šä¸‹æ–‡]
    
    G --> V[è¿”å›å¤„ç†ç»“æœ]
    S --> V
    U --> W[ç”¨æˆ·æ‰§è¡Œä»»åŠ¡]
    
    style K fill:#f3e5f5
    style N fill:#e8f5e8
    style Q fill:#fff3e0
```

## å˜é‡ä½œç”¨åŸŸåˆ†æ ğŸ”¥æ‰©å±•
- **æ¨¡å—ä½œç”¨åŸŸ**: å¯¼å…¥æ¨¡å—ã€HAS_LARGE_FILE_HANDLERæ ‡å¿—ã€project_root
- **ç±»ä½œç”¨åŸŸ**: TaskExecutorå’ŒTaskExecuteToolçš„æ–¹æ³•å®šä¹‰
- **å®ä¾‹ä½œç”¨åŸŸ**: 
  - åŸæœ‰ï¼štask_managerã€phase_controllerã€state_trackerç­‰
  - **ğŸ”¥æ–°å¢**: large_file_thresholdã€enable_chunkingé…ç½®
- **æ–¹æ³•ä½œç”¨åŸŸ**: 
  - åŸæœ‰ï¼šä»»åŠ¡å¯¹è±¡ã€ä¸Šä¸‹æ–‡ä¿¡æ¯ã€æ¨¡æ¿æ•°æ®ç­‰
  - **ğŸ”¥æ–°å¢**: åˆ†ç‰‡ç»“æœã€æ–‡æ¡£ç‰‡æ®µã€åˆå¹¶æ•°æ®ç­‰

## æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§ ğŸ”¥æ–°å¢
- **è‡ªåŠ¨åŒ–å¤„ç†**: å¤§æ–‡ä»¶å®Œå…¨è‡ªåŠ¨åŒ–å¤„ç†ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
- **å†…å­˜æ•ˆç‡**: åˆ†ç‰‡å¤„ç†é¿å…å¤§æ–‡ä»¶å…¨é‡å†…å­˜åŠ è½½
- **å¹¶è¡Œå‹å¥½**: åˆ†ç‰‡æ¶æ„æ”¯æŒæœªæ¥å¹¶è¡Œæ–‡æ¡£ç”Ÿæˆ
- **ç¼“å­˜åˆ©ç”¨**: åˆ†ç‰‡ç»“æœå¯è¢«ç¼“å­˜ç³»ç»Ÿåˆ©ç”¨
- **é”™è¯¯éš”ç¦»**: å¤§æ–‡ä»¶å¤„ç†å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡

## é”™è¯¯å¤„ç†æœºåˆ¶ ğŸ”¥å¢å¼º
- **åˆ†å±‚å¤„ç†**: ç©ºæ–‡ä»¶ â†’ å¤§æ–‡ä»¶ â†’ å¸¸è§„ä»»åŠ¡çš„é”™è¯¯éš”ç¦»
- **è‡ªåŠ¨æ¢å¤**: å¤§æ–‡ä»¶å¤„ç†å¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤ä»»åŠ¡çŠ¶æ€
- **ä¼˜é›…é™çº§**: åˆ†ç‰‡å¤±è´¥æ—¶ä¸ä¸­æ–­æ­£å¸¸ä»»åŠ¡æµç¨‹
- **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„é”™è¯¯æ—¥å¿—å’Œå¤„ç†è½¨è¿¹
- **çŠ¶æ€ä¸€è‡´**: ç¡®ä¿ä»»åŠ¡çŠ¶æ€çš„ä¸€è‡´æ€§å’Œå¯æ¢å¤æ€§

## å‡½æ•°ä¾èµ–å…³ç³» ğŸ”¥æ›´æ–°
- `execute_task` â†’ `_check_and_handle_empty_file` â†’ `_check_and_handle_large_file` é¢„å¤„ç†é“¾
- `_check_and_handle_large_file` â†’ `FileService.read_file_with_chunking` â†’ `_process_chunks_and_merge` å¤§æ–‡ä»¶å¤„ç†é“¾
- `_process_chunks_and_merge` â†’ `_sort_chunks_by_dependencies` â†’ `_generate_chunk_documentation` â†’ `_merge_chunk_documentations` åˆ†ç‰‡æ–‡æ¡£ç”Ÿæˆé“¾
- `_generate_chunk_documentation` â†’ `_generate_class_chunk_doc`/`_generate_function_chunk_doc`/`_generate_module_chunk_doc`/`_generate_generic_chunk_doc` ä¸“ä¸šæ–‡æ¡£ç”Ÿæˆé“¾
- `get_chunking_stats` â†’ `FileService.large_file_handler` ç»Ÿè®¡ä¿¡æ¯é“¾
- æ‰€æœ‰æ–¹æ³• â†’ `logger` æ—¥å¿—è®°å½•é“¾

## ğŸ”¥æ–°åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹

### å¤§æ–‡ä»¶è‡ªåŠ¨å¤„ç†
```python
# åˆå§‹åŒ–æ‰§è¡Œå™¨ï¼ˆè‡ªåŠ¨å¯ç”¨å¤§æ–‡ä»¶å¤„ç†ï¼‰
executor = TaskExecutor("/path/to/project")

# æ‰§è¡Œæ–‡ä»¶æ‘˜è¦ä»»åŠ¡ï¼ˆè‡ªåŠ¨æ£€æµ‹å¤§æ–‡ä»¶ï¼‰
result = executor.execute_task("file_summary_task_id")

# æ£€æŸ¥æ˜¯å¦æ˜¯å¤§æ–‡ä»¶è‡ªåŠ¨å¤„ç†
if result.get('chunking_info'):
    print(f"å¤§æ–‡ä»¶è‡ªåŠ¨å¤„ç†å®Œæˆ: {result['chunking_info']['total_chunks']} ä¸ªåˆ†ç‰‡")
    print(f"å¤„ç†æ–¹æ³•: {result['chunking_info']['processing_method']}")
    print(f"å¤„ç†æ—¶é—´: {result['chunking_info']['processing_time']:.2f}ç§’")
```

### åˆ†ç‰‡ç»Ÿè®¡æŸ¥è¯¢
```python
# è·å–åˆ†ç‰‡å¤„ç†ç»Ÿè®¡
stats = executor.get_chunking_stats()
if stats.get('chunking_enabled'):
    print(f"åˆ†ç‰‡åŠŸèƒ½å·²å¯ç”¨ï¼Œé˜ˆå€¼: {stats['threshold_kb']} KB")
    print(f"å·²å¤„ç†æ–‡ä»¶: {stats['total_files_processed']} ä¸ª")
    print(f"å·²ç”Ÿæˆåˆ†ç‰‡: {stats['total_chunks_created']} ä¸ª")
```

### ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€æ£€æŸ¥
```python
# æ‰§è¡Œä»»åŠ¡å¹¶æ£€æŸ¥ç±»å‹
result = executor.execute_task(task_id)

if result.get('task_completed'):
    if 'chunking_info' in result:
        print("å¤§æ–‡ä»¶è‡ªåŠ¨åˆ†ç‰‡å¤„ç†å®Œæˆ")
    elif result.get('auto_generated'):
        print("ç©ºæ–‡ä»¶è‡ªåŠ¨å¤„ç†å®Œæˆ")
    else:
        print("å¸¸è§„ä»»åŠ¡éœ€è¦ç»§ç»­æ‰§è¡Œ")
```