# CodeLens 系统架构概述

## 项目概况
CodeLens是专为Claude Code设计的智能化任务驱动MCP服务器，实现完整的5阶段文档生成工作流。通过智能项目分析、任务自动生成、依赖关系管理和实时进度监控，为AI提供结构化的项目理解和协作式文档生成能力。支持热重载功能，提供开发时的实时代码更新体验。

### 核心特性
- **智能项目分析**: 自动识别项目类型、框架和技术栈，生成定制化文档策略
- **任务驱动架构**: 支持9种任务类型的智能调度和依赖管理
- **5阶段严格控制**: 100%完成率要求的阶段转换机制
- **实时状态监控**: 完整的执行历史、性能指标和健康检查
- **协作式工作流**: 7个核心MCP工具提供端到端的文档生成支持
- **热重载支持**: 开发时实时监控代码变化，自动重载模块，无需重启服务

## 技术栈分析

### 核心技术栈
- **开发语言**: Python 3.9+ (核心功能零外部依赖)
- **协作协议**: MCP (Model Context Protocol)
- **文档架构**: 三层体系 (Architecture/File/Project)
- **任务管理**: 智能依赖调度和状态持久化
- **文件处理**: pathlib + glob + 智能过滤 + 大文件分片处理（50KB分片/120KB上限）
- **数据格式**: JSON结构化响应
- **状态存储**: JSON持久化文件系统
- **模板系统**: 10个核心模板统一管理
- **热重载系统**: watchdog文件监控 + importlib模块重载，支持轮询备用方案

## 架构模式

### 1. 任务引擎层 (Task Engine Layer)
智能化任务驱动核心，实现完整的任务生命周期管理
- **TaskManager**: 智能任务管理器，支持9种任务类型、依赖关系和优先级调度
- **PhaseController**: 5阶段严格控制器，确保100%完成率的阶段转换  
- **StateTracker**: 持久化状态跟踪，支持执行历史、性能监控和健康检查

#### 支持的14种任务类型
- **SCAN**: 项目扫描任务
- **FILE_SUMMARY**: 文件摘要生成
- **MODULE_ANALYSIS**: 模块分析
- **MODULE_RELATIONS**: 模块关系分析
- **DEPENDENCY_GRAPH**: 依赖图生成
- **MODULE_README**: 模块README
- **MODULE_API**: 模块API文档
- **MODULE_FLOW**: 模块流程文档
- **ARCHITECTURE**: 系统架构
- **TECH_STACK**: 技术栈分析
- **DATA_FLOW**: 数据流设计
- **SYSTEM_ARCHITECTURE**: 系统架构图
- **COMPONENT_DIAGRAM**: 组件关系图
- **DEPLOYMENT_DIAGRAM**: 部署架构图
- **PROJECT_README**: 项目README

### 2. 服务层 (Services Layer)
核心业务逻辑服务组件
- **FileService**: 项目文件扫描、智能过滤和项目类型检测
- **TemplateService**: 16个核心模板统一管理，四层架构支持
- **ValidationService**: 文档结构验证和完整性状态报告

### 3. MCP接口层 (MCP Interface Layer)  
7个专业MCP工具，提供完整的智能化工作流
- **init_tools**: 工作流指导工具，提供标准5阶段操作步骤指导
- **doc_guide**: 智能项目分析器，自动识别项目类型、框架和生成策略
- **task_init**: 任务计划生成器，基于分析结果创建5阶段执行计划
- **task_execute**: 任务执行管理器，提供模板、上下文和执行指导
- **task_status**: 状态监控中心，实时进度跟踪和健康诊断
- **task_complete**: 任务完成工具，标记任务完成并验证输出质量
- **doc_scan**: 项目文件扫描工具，智能过滤和结构化数据提取

### 4. 热重载系统层 (Hot Reload Layer)
开发时实时代码更新支持
- **HotReloadManager**: 热重载协调管理器，统一管理热重载流程
- **FileWatcher**: 文件监控器，支持watchdog实时监控和轮询备用方案
- **ModuleReloader**: 模块重载器，安全重载Python模块，支持依赖分析

### 5. 协作流程层 (Collaboration Layer)
完整的5阶段智能化协作流程：
1. **项目分析** (doc_guide): 智能识别项目特征，生成文档策略
2. **任务规划** (task_init): 基于分析结果，生成结构化任务计划  
3. **任务执行** (task_execute): 逐步执行任务，提供上下文和模板支持
4. **进度监控** (task_status): 实时跟踪执行状态和健康诊断
5. **任务完成** (task_complete): 标记任务完成并验证输出质量

#### 5阶段文档生成流程
- **Phase 1**: 项目扫描和分析 (1个任务)
- **Phase 2**: 文件层文档生成 (1-50个任务)
- **Phase 3**: 模块层架构分析 (6-20个任务)
- **Phase 4**: 架构层文档生成 (6个任务)
- **Phase 5**: 项目层总结文档 (1个任务)

## 核心组件

### TaskManager
智能任务管理器核心实现
- **任务生命周期**: 创建、状态跟踪、依赖验证、优先级调度
- **状态管理**: 支持PENDING/IN_PROGRESS/COMPLETED/FAILED/BLOCKED五种状态
- **依赖关系**: 自动构建任务依赖图，确保执行顺序正确
- **优先级系统**: 高/中/低三级优先级，智能调度算法
- **持久化存储**: JSON格式任务状态文件，支持系统重启恢复

### PhaseController  
5阶段严格流程控制器
- **严格阶段控制**: 100%完成率要求，确保阶段间依赖
- **阶段转换验证**: 自动检查前置阶段完成状态
- **进度门控机制**: 阻塞未满足条件的阶段转换
- **智能状态推断**: 基于任务状态自动推断当前阶段
- **健康检查**: 检测阶段一致性和任务分布合理性

### StateTracker
执行状态跟踪和监控中心
- **实时状态监控**: 跟踪任务执行状态和阶段进度
- **执行历史记录**: 完整的任务执行时间轴和状态变更
- **性能指标统计**: 任务执行时间、成功率、效率分析
- **健康诊断**: 系统健康状态评估和异常检测
- **事件追踪**: 详细的操作日志和性能监控

### FileService
项目文件扫描和智能分析服务
- **智能文件过滤**: 基于项目类型和配置的智能过滤机制
- **项目类型检测**: 自动识别Python/JavaScript/Java/Go/Rust项目
- **目录树构建**: 生成结构化的目录树和文件统计
- **元数据提取**: 文件大小、类型、修改时间等详细信息
- **性能优化**: 大文件跳过、无关目录排除

### TemplateService  
模板资源统一管理服务
- **16个核心模板**: 四层架构的完整模板集合
- **智能查询系统**: 支持按名称、类型、层级多维度查询  
- **模板格式化**: 变量替换和内容格式化功能
- **元数据管理**: 模板描述、变量定义、使用示例
- **层级支持**: Architecture(6个)/Module(6个)/File(1个)/Project(3个)

### ValidationService
文档结构验证和完整性检查
- **结构验证**: 检查文档目录结构的完整性
- **文件存在性**: 验证预期文档文件是否存在  
- **状态报告**: 生成详细的完成度和缺失分析
- **多种验证模式**: full_status/structure_only/summary/missing_files

## 数据流设计

### 完整的5阶段智能化工作流程

#### 阶段1: 智能项目分析 (doc_guide)
```
项目路径 → 项目类型检测 → 框架识别 → 模块发现 → 文档策略生成
```
- **ProjectAnalyzer**: 支持Python/JS/Java/Go/Rust项目类型检测
- **框架识别**: Django/Flask/React/Spring等8+主流框架自动识别  
- **策略生成**: 基于项目复杂度生成定制化文档策略

#### 阶段2: 任务计划生成 (task_init)
```
分析结果 → 5阶段任务生成 → 依赖关系构建 → 优先级排序 → 执行计划
```
- **TaskPlanGenerator**: 智能生成14种类型任务
- **依赖图构建**: 自动建立任务间依赖关系
- **时间估算**: 基于项目规模估算完成时间

#### 阶段3: 任务执行管理 (task_execute)  
```
任务选择 → 依赖验证 → 上下文构建 → 模板获取 → 执行指导
```
- **TaskExecutor**: 3种执行模式(prepare/execute/complete)
- **智能上下文**: 文件/模块/项目/阶段四类上下文自动构建
- **模板集成**: 与16个模板系统无缝集成

#### 阶段4: 实时状态监控 (task_status)
```
状态查询 → 进度分析 → 健康检查 → 下一步行动
```
- **5种检查类型**: current_task/phase_progress/overall_status/next_actions/health_check
- **智能诊断**: 系统健康状态和性能指标分析
- **行动分析**: 基于当前状态分析下一步行动

#### 阶段5: 文档验证确认 (doc_verify)  
```
结构检查 → 完整性验证 → 状态报告 → 质量确保
```
- **多维度验证**: 4种验证模式满足不同需求
- **完整性分析**: 详细的缺失文件分析
- **质量保证**: 确保文档生成符合标准

### 严格阶段控制
- 100%完成率要求：每阶段必须达到100%完成率才能进入下一阶段
- 依赖关系验证：自动检查任务依赖关系，确保执行顺序正确
- 状态持久化：实时保存执行状态，支持中断恢复

## 系统边界和约束
- **项目类型**: 支持Python/JavaScript/Java/Go/Rust等主流项目
- **文件大小**: 单文件最大120KB，50KB以上自动分片处理，智能过滤优化性能
- **部署方式**: 命令行工具 + MCP服务器
- **设计原则**: 智能化任务驱动，协作式文档生成

## 部署架构

### 命令行使用
```bash
# 智能项目分析
python src/mcp_tools/doc_guide.py /path/to/project

# 任务管理
python src/mcp_tools/task_init.py /path/to/project --analysis-file analysis.json
python src/mcp_tools/task_execute.py /path/to/project --task-id <task_id> --mode execute
python src/mcp_tools/task_status.py /path/to/project --type overall_status

# 文件和模板操作
python src/mcp_tools/doc_scan.py /path/to/project --no-content
python src/mcp_tools/doc_verify.py /path/to/project
```

### MCP服务器集成
支持Claude Code直接调用7个MCP工具，提供完整的智能化文档生成工作流

## 智能特性

### 项目分析智能化
- **自动项目类型检测**: 基于文件特征、目录结构、配置文件的多维度评分
- **框架识别**: 内容分析和模式匹配，支持Django/Flask/React/Vue等主流框架
- **模块自动发现**: 基于目录结构和文件命名模式的智能模块识别
- **复杂度评估**: simple/medium/complex三级复杂度自动评估

### 任务调度智能化  
- **智能依赖管理**: 自动构建任务依赖图，确保执行顺序
- **优先级算法**: 文件重要性评分和优先级智能分配
- **阶段门控**: 严格的100%完成率要求和阶段转换控制
- **执行策略**: 基于项目复杂度的自适应执行策略

### 监控诊断智能化
- **健康检查**: 系统状态、任务分布、依赖完整性全面诊断
- **性能监控**: 执行时间、成功率、效率等性能指标统计
- **异常检测**: 自动识别任务异常和系统问题
- **行动分析**: 基于当前状态分析具体的执行状态

## 技术优势

### 零依赖架构
- **纯Python标准库**: 无需安装任何外部依赖
- **轻量级设计**: 最小化资源占用和启动时间
- **跨平台兼容**: 支持Windows/macOS/Linux全平台

### 高性能优化
- **智能文件过滤**: 大幅减少无关文件处理，提升扫描效率
- **按需加载**: 模板和数据按需获取，优化内存使用
- **异步处理**: 支持并发任务执行，提升整体性能
- **状态持久化**: 支持中断恢复，提升长时间任务稳定性