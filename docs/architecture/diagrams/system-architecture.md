
# CodeLens 系统架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Claude Code                         │
│                     (文档生成客户端)                        │
└─────────────────────┬───────────────────────────────────────┘
                      │ MCP 协议调用
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   MCP 接口层                               │
├─────────────────┬─────────────────┬─────────────────────────┤
│   doc_scan      │  template_get   │     doc_verify          │
│  项目文件扫描    │   模板获取      │     文档验证            │
└─────────────────┼─────────────────┼─────────────────────────┘
                  │                 │
                  ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                   服务层 (Services)                        │
├──────────────┬──────────────┬──────────────┬─────────────────┤
│ FileService  │TemplateService│ValidationService│LoggingService│
│ 文件信息服务  │   模板服务     │   验证服务      │   日志服务     │
└──────────────┼──────────────┼──────────────┼─────────────────┘
               │              │              │
               ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────┐
│                   基础设施层                               │
├─────────────────┬─────────────────┬─────────────────────────┤
│   文件系统       │    模板资源      │      日志基础设施        │
│  pathlib/glob   │   Markdown      │   LogManager/Rotator    │
└─────────────────┴─────────────────┴─────────────────────────┘
```

## 详细组件架构

### MCP 接口层
```
┌─────────────────────────────────────────────────────────────┐
│                     MCP Tools Layer                        │
├─────────────────┬─────────────────┬─────────────────────────┤
│   doc_scan.py   │ template_get.py │    doc_verify.py        │
├─────────────────┼─────────────────┼─────────────────────────┤
│ • 项目文件扫描   │ • 模板查询      │ • 文档结构验证           │
│ • 元数据提取     │ • 格式化       │ • 完成状态检查           │
│ • 目录树生成     │ • 变量验证      │ • 缺失文件报告           │
│ • JSON响应      │ • JSON响应      │ • JSON响应              │
└─────────────────┴─────────────────┴─────────────────────────┘
```

### 服务层架构
```
┌─────────────────────────────────────────────────────────────┐
│                   Services Layer                           │
├──────────────┬──────────────┬──────────────┬─────────────────┤
│ FileService  │TemplateService│ValidationService│LoggingService│
├──────────────┼──────────────┼──────────────┼─────────────────┤
│• 文件扫描     │• 模板管理     │• 目录检查     │• 操作追踪       │
│• 元数据提取   │• 内容查询     │• 状态验证     │• 日志格式化     │
│• 目录树构建   │• 变量验证     │• 报告生成     │• 文件轮转       │
│• 统计分析     │• 格式化      │• 建议提供     │• 性能监控       │
└──────────────┴──────────────┴──────────────┴─────────────────┘
```

### 日志系统架构
```
┌─────────────────────────────────────────────────────────────┐
│                  Logging System                            │
├─────────────────┬─────────────────┬─────────────────────────┤
│   LogManager    │   FileRotator   │      LogConfig          │
├─────────────────┼─────────────────┼─────────────────────────┤
│• 统一日志管理    │• 文件轮转       │• 配置管理               │
│• 结构化格式     │• 自动压缩       │• 运行时更新             │
│• 异步写入       │• 磁盘清理       │• JSON配置文件           │
│• 操作追踪       │• 大小/时间轮转   │• 环境变量支持           │
└─────────────────┴─────────────────┴─────────────────────────┘
```

## 数据流架构
```
Claude Code 请求
        ↓
    MCP 工具接收
        ↓
    参数验证处理
        ↓
    调用对应服务 ──→ 日志记录开始
        ↓                ↓
    业务逻辑处理 ──→ 操作追踪记录
        ↓                ↓
    结果格式化   ──→ 性能统计记录
        ↓                ↓
    JSON响应返回 ──→ 日志记录结束
        ↓                ↓
    Claude Code  ←─ 异步日志写入
```

## 技术栈架构
```
┌─────────────────────────────────────────────────────────────┐
│                   Application Layer                        │
│               Python 3.9+ / MCP Protocol                  │
├─────────────────────────────────────────────────────────────┤
│                   Framework Layer                          │
│           pathlib / glob / json / threading                │
├─────────────────────────────────────────────────────────────┤
│                    System Layer                            │
│               File System / OS Resources                   │
└─────────────────────────────────────────────────────────────┘
```

这是一个专为 Claude Code 协作设计的 MCP 服务器，采用模块化分层架构，具有完整的日志系统和可观测性能力。
