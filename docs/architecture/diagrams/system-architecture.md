
# CodeLens 系统架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Claude Code                         │
│                   (智能化文档生成客户端)                    │
└─────────────────────┬───────────────────────────────────────┘
                      │ MCP 协议调用 (7个专业工具)
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   MCP 接口层 (7个工具)                     │
├─────────────────┬─────────────────┬─────────────────────────┤
│   doc_guide     │    task_init    │    task_execute         │
│  智能项目分析    │   任务计划生成  │    任务执行管理         │
├─────────────────┼─────────────────┼─────────────────────────┤
│  task_status    │    doc_scan     │    template_get         │
│  状态监控中心    │  项目文件扫描   │     模板获取            │
├─────────────────┼─────────────────┼─────────────────────────┤
│   doc_verify    │                 │                         │
│   文档验证      │                 │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   任务引擎层 (Task Engine)                 │
├──────────────┬──────────────┬──────────────┬─────────────────┤
│ TaskManager  │PhaseController│ StateTracker │   智能调度算法   │
│ 14种任务管理  │ 5阶段严格控制 │ 状态跟踪监控  │  依赖图+优先级   │
└──────────────┼──────────────┼──────────────┼─────────────────┘
               │              │              │
               ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────┐
│                   服务层 (Services)                        │
├──────────────┬──────────────┬──────────────┬─────────────────┤
│ FileService  │TemplateService│ValidationService│              │
│ 智能文件分析  │ 16个核心模板  │  完整性验证    │                 │
│ 项目类型检测  │ 四层架构支持  │  多种验证模式   │                 │
└──────────────┼──────────────┼──────────────┼─────────────────┘
               │              │              │
               ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────┐
│                   基础设施层                               │
├─────────────────┬─────────────────┬─────────────────────────┤
│   文件系统       │    模板资源      │     状态存储            │
│  pathlib/glob   │   Markdown      │   JSON持久化文件        │
│  智能过滤       │   16个模板       │   .codelens/tasks.json  │
└─────────────────┴─────────────────┴─────────────────────────┘
```

## 详细组件架构

### MCP 接口层 (7个专业工具)
```
┌─────────────────────────────────────────────────────────────┐
│                     MCP Tools Layer (7个工具)             │
├─────────────────┬─────────────────┬─────────────────────────┤
│   doc_guide.py  │   task_init.py  │  task_execute.py        │
├─────────────────┼─────────────────┼─────────────────────────┤
│ • 智能项目分析   │ • 任务计划生成  │ • 任务执行管理           │
│ • 项目类型检测   │ • 4阶段规划     │ • 上下文构建            │
│ • 框架识别      │ • 依赖图构建     │ • 模板集成              │
│ • 文档策略生成   │ • 优先级排序    │ • 3种执行模式           │
├─────────────────┼─────────────────┼─────────────────────────┤
│ task_status.py  │   doc_scan.py   │  template_get.py        │
├─────────────────┼─────────────────┼─────────────────────────┤
│ • 状态监控      │ • 项目文件扫描   │ • 模板查询              │
│ • 进度跟踪      │ • 智能过滤      │ • 三层架构支持           │
│ • 健康诊断      │ • 元数据提取     │ • 格式化               │
│ • 执行建议      │ • 目录树生成     │ • 变量验证              │
├─────────────────┼─────────────────┼─────────────────────────┤
│  doc_verify.py  │                 │                         │
├─────────────────┤                 │                         │
│ • 文档验证      │                 │                         │
│ • 完整性检查     │                 │                         │
│ • 改进建议      │                 │                         │
│ • 多种验证模式   │                 │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
```

### 任务引擎层架构
```
┌─────────────────────────────────────────────────────────────┐
│                   Task Engine Layer                        │
├──────────────┬──────────────┬──────────────┬─────────────────┤
│ TaskManager  │PhaseController│ StateTracker │   调度算法       │
├──────────────┼──────────────┼──────────────┼─────────────────┤
│• 任务创建管理 │• 5阶段控制   │• 状态跟踪     │• DAG依赖图       │
│• 14种任务类型 │• 100%完成率  │• 执行历史     │• 优先级算法      │
│• 依赖关系验证 │• 阶段转换门控 │• 性能监控     │• 智能调度        │
│• 状态持久化  │• 健康检查     │• 异常检测     │• 并发安全        │
└──────────────┴──────────────┴──────────────┴─────────────────┘
```

**14种支持任务类型**:
- **Phase 1**: SCAN (项目扫描)
- **Phase 2**: FILE_SUMMARY (文件摘要) 
- **Phase 3**: MODULE_ANALYSIS, MODULE_RELATIONS, DEPENDENCY_GRAPH, MODULE_README, MODULE_API, MODULE_FLOW
- **Phase 4**: ARCHITECTURE, TECH_STACK, DATA_FLOW, SYSTEM_ARCHITECTURE, COMPONENT_DIAGRAM, DEPLOYMENT_DIAGRAM
- **Phase 5**: PROJECT_README (项目README)

### 服务层架构
```
┌─────────────────────────────────────────────────────────────┐
│                   Services Layer                           │
├──────────────┬──────────────┬──────────────┬─────────────────┤
│ FileService  │TemplateService│ValidationService│               │
├──────────────┼──────────────┼──────────────┼─────────────────┤
│• 智能文件扫描 │• 16个核心模板 │• 文档结构验证  │                 │
│• 项目类型检测 │• 四层架构支持 │• 完整性检查    │                 │
│• 框架识别    │• 智能查询系统 │• 改进建议     │                 │
│• 元数据提取  │• 模板格式化   │• 多种验证模式  │                 │
│• 目录树构建  │• 变量管理     │• 状态报告     │                 │
└──────────────┴──────────────┴──────────────┴─────────────────┘
```

## 智能化协作数据流
```
Claude Code 请求
        ↓
    MCP 工具接收 (7个专业工具)
        ↓
    参数验证处理
        ↓
    任务引擎调用 ──→ TaskManager/PhaseController/StateTracker
        ↓                ↓
    服务层处理    ──→ FileService/TemplateService/ValidationService  
        ↓                ↓
    智能分析执行  ──→ 项目分析/任务生成/状态跟踪
        ↓                ↓
    结果格式化    ──→ JSON结构化响应
        ↓                ↓
    Claude Code   ←── 完整响应数据
```

## 5阶段文档生成流程
```
Phase 1: 项目扫描 ──→ Phase 2: 文件层文档 ──→ Phase 3: 模块层架构
        │                     │                      │
        ├─ 1个SCAN任务         ├─ 1-50个FILE_SUMMARY  ├─ 6-20个MODULE_*任务  
        │                     │                      │
        ↓                     ↓                      ↓
Phase 4: 架构层设计 ──→ Phase 5: 项目层总结
        │                     │
        ├─ 6个ARCHITECTURE     ├─ 1个PROJECT_README
        │   相关任务            │
        ↓                     ↓
    100%完成检查 ──→ 最终文档验证
```

## 技术栈架构
```
┌─────────────────────────────────────────────────────────────┐
│                   Application Layer                        │
│               Python 3.9+ / MCP Protocol                  │
├─────────────────────────────────────────────────────────────┤
│                   Framework Layer                          │
│           pathlib / glob / json / threading                │
├─────────────────────────────────────────────────────────────┤
│                    System Layer                            │
│               File System / OS Resources                   │
└─────────────────────────────────────────────────────────────┘
```

这是一个专为 Claude Code 协作设计的智能化任务驱动 MCP 服务器，采用四层分层架构，具有完整的任务引擎、智能项目分析和5阶段严格控制能力。
